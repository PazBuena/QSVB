<!DOCTYPE html>
<html lang="pt-BR"> 
<head>
  <meta charset="UTF-8" />
  <title>MM</title>
  <style>
    body { font-family: arial; size: 12px; margin: 1rem; }
    textarea { width: 100%; height: 400px; white-space: pre-wrap; overflow-x: hidden; font-family: monospace; }
  </style>
</head>
<body>
  <h2>MM</h2>

  <label for="file">Arquivo:</label>
  <input type="file" id="file" accept=".enc" /><br><br>

  <label for="password">Senha:</label>
  <input type="password" id="password" /><br><br>

  <button onclick="decryptFile()">Descriptografar</button>

  <h3>Resultado:</h3>
  <textarea id="output" placeholder="O conteúdo do arquivo aparecerá aqui."></textarea>

  <script>
    const ITERATIONS = 20859300;
    const SALT_SIZE = 16;
    const IV_SIZE = 16;
    const KEY_SIZE = 256;

    async function decryptFile() {
      const fileInput = document.getElementById('file');
      const password = document.getElementById('password').value;
      const output = document.getElementById('output');

      if (!fileInput.files[0]) {
        alert("Selecione um arquivo .enc");
        return;
      }
      if (!password) {
        alert("Digite a senha");
        return;
      }

      const fileBuffer = await fileInput.files[0].arrayBuffer();
      const data = new Uint8Array(fileBuffer);

      const salt = data.slice(0, SALT_SIZE);
      const iv = data.slice(SALT_SIZE, SALT_SIZE + IV_SIZE);
      const ciphertext = data.slice(SALT_SIZE + IV_SIZE);

      try {
        const keyMaterial = await window.crypto.subtle.importKey(
          "raw",
          new TextEncoder().encode(password),
          { name: "PBKDF2" },
          false,
          ["deriveKey"]
        );

        const key = await window.crypto.subtle.deriveKey(
          {
            name: "PBKDF2",
            salt: salt,
            iterations: ITERATIONS,
            hash: "SHA-256"
          },
          keyMaterial,
          { name: "AES-CBC", length: KEY_SIZE },
          false,
          ["decrypt"]
        );

        const decrypted = await window.crypto.subtle.decrypt(
          {
            name: "AES-CBC",
            iv: iv
          },
          key,
          ciphertext
        );

        const decoder = new TextDecoder("utf-8");
        const plaintext = decoder.decode(decrypted);

        output.value = plaintext;

      } catch (err) {
        alert("Erro ao descriptografar: verifique a senha ou formato do arquivo.");
      }

      document.getElementById('password').value = '';
    }
  </script>
</body>
</html>
